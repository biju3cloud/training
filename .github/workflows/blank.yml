name: Deploy DDL to Azure SQL

on:
  workflow_dispatch:     # Manual trigger only

jobs:
  deploy-ddl:
    runs-on: ubuntu-latest

    steps:
    # Checkout repo
    - name: Checkout
      uses: actions/checkout@v3

    # Login to Azure using a service principal
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_SP_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_SP_CLIENT_SECRET }}",
            "tenantId": "${{ secrets.AZURE_SP_TENANT_ID }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          }

    # Install SQLCMD
    - name: Install sqlcmd
      run: |
        sudo apt-get update
        sudo apt-get install -y mssql-tools unixodbc-dev
        echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bash_profile
        echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bashrc
        source ~/.bashrc

    # Execute all SQL files
    - name: Deploy DDL scripts
      run: |
        echo "Deploying SQL scripts..."

        for file in $(find ${{ secrets.SQL_FOLDER_PATH }} -name "*.sql" | sort); do
          echo "Running $file"
          /opt/mssql-tools/bin/sqlcmd \
            -S "${{ secrets.AZURE_SQL_SERVER }}" \
            -d "${{ secrets.AZURE_SQL_DATABASE }}" \
            -U "${{ secrets.AZURE_SQL_USERNAME }}" \
            -P "${{ secrets.AZURE_SQL_PASSWORD }}" \
            -i "$file"
        done

        echo "Deployment complete."
